name: Deploy

on:
  push:
    branches: [ 'master' ]

concurrency: serial

env:
  CONTEXT_NAME: "remote"
  VIRTUAL_HOST_NAME: "zeckson.com"

jobs:
  deploy:
    name: 'Publish on the remote server'

    runs-on: ubuntu-latest

    environment:
      name: Production
      url: https://${{ env.VIRTUAL_HOST_NAME }}

    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
      - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
      - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Checkout
        uses: actions/checkout@v4

      # 1. Configure SSH
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      # 2. Optional: Disable strict host checking
      - name: Trust remote host
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_REMOTE_URL }}" | awk -F@ '{print $2}' >> ~/.ssh/known_hosts
          ssh-keyscan $(echo "${{ secrets.SSH_REMOTE_URL }}" | awk -F@ '{print $2}') >> ~/.ssh/known_hosts 2>/dev/null

      # 3. Create Docker context using SSH
      - name: Create Docker context
        run: |
          docker context create remote \
            --docker "host=ssh://${{ secrets.SSH_REMOTE_URL }}" || true
          docker context use remote
          docker info

      # 4. Deploy using docker compose ON THE REMOTE HOST
      - name: Deploy via Docker Compose
        run: |
          docker compose up -d
